<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ahorro Challenge</title>
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ahorro">
    <meta name="theme-color" content="#10b981">
    
    <link rel="apple-touch-icon" sizes="512x512" href="https://i.ibb.co/m5p3Srk/image.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://i.ibb.co/m5p3Srk/image.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#10b981', secondary: '#0ea5e9', background: '#f8fafc' },
                    fontFamily: { display: ['Outfit', 'sans-serif'], body: ['Plus Jakarta Sans', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        body { background: radial-gradient(circle at top right, #f0fdf4, #f8fafc 50%), radial-gradient(circle at bottom left, #eff6ff, #f8fafc 50%); min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .badge-active { background: #10b981 !important; color: white !important; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
    </style>
</head>
<body class="font-body text-slate-800">

    <div class="max-w-6xl mx-auto px-4 py-6">
        
        <header class="mb-8 flex flex-col md:flex-row gap-6 items-start justify-between">
            <div>
                <h1 class="text-3xl font-display font-bold text-slate-900">
                    Ahorro <span class="text-primary">Challenge</span>
                </h1>
                <div class="flex gap-2 mt-2">
                    <button onclick="setStatsView('COLECTIVO')" id="btnViewCol" class="px-3 py-1 text-xs font-bold rounded-full transition-all border border-primary text-primary">VISTA COLECTIVA</button>
                    <button onclick="setStatsView('INDIVIDUAL')" id="btnViewInd" class="px-3 py-1 text-xs font-bold rounded-full transition-all border border-slate-200 text-slate-400">VISTA INDIVIDUAL</button>
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-4 flex items-center gap-6 min-w-[280px] border-l-4 border-l-primary shadow-sm">
                <div class="relative w-14 h-14 shrink-0">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="28" cy="28" r="24" stroke="currentColor" stroke-width="5" fill="transparent" class="text-slate-100" />
                        <circle id="globalProgressCircle" cx="28" cy="28" r="24" stroke="currentColor" stroke-width="5" fill="transparent" 
                            stroke-dasharray="150.8" stroke-dashoffset="150.8"
                            class="text-primary transition-all duration-700" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center text-xs font-bold" id="progressPercentage">0%</div>
                </div>
                <div>
                    <div class="text-[10px] font-bold uppercase text-slate-400" id="statsTitle">Total Colectivo</div>
                    <div class="text-xl font-bold font-display text-slate-900" id="totalSavedCounter">0 Gs.</div>
                    <div class="text-[11px] text-slate-500"><span id="completedCount">0</span> de 52 metas</div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <aside class="space-y-4">
                <div class="glass-card rounded-2xl p-4 shadow-sm">
                    <h2 class="text-sm font-bold mb-3 uppercase tracking-wider text-slate-500">Participantes</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newParticipantInput" placeholder="Nombre..." class="w-full bg-white border border-slate-200 rounded-lg px-3 py-1.5 text-sm outline-none focus:ring-1 focus:ring-primary">
                        <button onclick="addParticipant()" class="bg-primary text-white p-2 rounded-lg hover:bg-emerald-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" /></svg>
                        </button>
                    </div>
                    <div id="participantList" class="space-y-1"></div>
                </div>

                <button onclick="confirmReset()" class="w-full py-2 text-xs font-bold text-rose-400 hover:text-rose-600 transition-colors flex justify-center items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    RESETEAR TODO
                </button>
            </aside>

            <main class="lg:col-span-3">
                <div class="flex overflow-x-auto pb-3 gap-2 no-scrollbar mb-4">
                    <button onclick="filterPhase('ALL')" class="phase-btn flex-none px-4 py-1.5 rounded-full bg-white border border-slate-200 text-xs font-bold hover:border-primary transition-all">Todas</button>
                    <button onclick="filterPhase('EMPEZAR')" class="phase-btn flex-none px-4 py-1.5 rounded-full bg-white border border-slate-200 text-xs font-bold hover:border-primary transition-all">Fase 1</button>
                    <button onclick="filterPhase('SOSTENER')" class="phase-btn flex-none px-4 py-1.5 rounded-full bg-white border border-slate-200 text-xs font-bold hover:border-primary transition-all">Fase 2</button>
                    <button onclick="filterPhase('CONSTANCIA')" class="phase-btn flex-none px-4 py-1.5 rounded-full bg-white border border-slate-200 text-xs font-bold hover:border-primary transition-all">Fase 3</button>
                    <button onclick="filterPhase('RESULTADOS')" class="phase-btn flex-none px-4 py-1.5 rounded-full bg-white border border-slate-200 text-xs font-bold hover:border-primary transition-all">Fase 4</button>
                </div>

                <div id="goalsList" class="space-y-2"></div>
            </main>
        </div>
    </div>

    <script>
        let challengeData = []; let participants = []; let activeParticipant = ""; let currentFilter = "ALL"; let statsView = "COLECTIVO";
        const formatPYG = (n) => new Intl.NumberFormat('es-PY').format(n) + ' Gs.';

        function generateWeeks() {
            challengeData = [];
            for (let i = 1; i <= 52; i++) {
                let phase = i <= 13 ? "EMPEZAR" : i <= 26 ? "SOSTENER" : i <= 39 ? "CONSTANCIA" : "RESULTADOS";
                challengeData.push({ week: i, amount: i * 10000, phase: phase, completions: [] });
            }
        }

        function save() { localStorage.setItem('ahorro_final_v12', JSON.stringify({ challengeData, participants, activeParticipant, statsView })); }

        function load() {
            const saved = localStorage.getItem('ahorro_final_v12');
            if (saved) {
                const p = JSON.parse(saved);
                challengeData = p.challengeData; participants = p.participants; activeParticipant = p.activeParticipant; statsView = p.statsView || "COLECTIVO";
            } else {
                participants = []; activeParticipant = ""; generateWeeks();
            }
        }

        function init() {
            load(); renderParticipants(); renderGoals(); updateStats(); setStatsView(statsView);
        }

        function renderParticipants() {
            const list = document.getElementById('participantList');
            if (participants.length === 0) { list.innerHTML = `<p class="text-[11px] text-slate-400 italic px-2">Crea un nombre arriba</p>`; return; }
            list.innerHTML = participants.map(p => `
                <div class="flex items-center bg-white/50 rounded-lg p-1 border border-transparent hover:border-slate-200">
                    <button onclick="setActiveParticipant('${p}')" class="flex-grow text-left px-3 py-1.5 text-sm font-semibold rounded-md transition-all ${p === activeParticipant ? 'badge-active' : 'text-slate-500'}">${p}</button>
                    <button onclick="deleteParticipant('${p}')" class="px-2 text-slate-300 hover:text-rose-500">X</button>
                </div>
            `).join('');
        }

        function addParticipant() {
            const name = document.getElementById('newParticipantInput').value.trim().toUpperCase();
            if (name && !participants.includes(name)) {
                participants.push(name); if (!activeParticipant) activeParticipant = name;
                document.getElementById('newParticipantInput').value = ''; save(); renderParticipants(); renderGoals(); updateStats();
            }
        }

        function deleteParticipant(name) {
            if (confirm(`¿Eliminar a ${name}?`)) {
                participants = participants.filter(p => p !== name);
                challengeData.forEach(g => g.completions = g.completions.filter(c => c.participant !== name));
                if (activeParticipant === name) activeParticipant = participants[0] || "";
                save(); renderParticipants(); renderGoals(); updateStats();
            }
        }

        function setActiveParticipant(name) { activeParticipant = name; renderParticipants(); renderGoals(); updateStats(); }

        function setStatsView(view) {
            statsView = view; updateStats();
            document.getElementById('btnViewCol').className = view === 'COLECTIVO' ? 'px-3 py-1 text-xs font-bold rounded-full border border-primary text-primary' : 'px-3 py-1 text-xs font-bold rounded-full border border-slate-200 text-slate-400';
            document.getElementById('btnViewInd').className = view === 'INDIVIDUAL' ? 'px-3 py-1 text-xs font-bold rounded-full border border-primary text-primary' : 'px-3 py-1 text-xs font-bold rounded-full border border-slate-200 text-slate-400';
        }

        function toggle(idx) {
            if (!activeParticipant) return alert("Agregá un nombre primero");
            const goal = challengeData[idx]; const cIdx = goal.completions.findIndex(c => c.participant === activeParticipant);
            if (cIdx > -1) goal.completions.splice(cIdx, 1);
            else goal.completions.push({ participant: activeParticipant, date: new Date().toLocaleDateString('es-PY') });
            save(); renderGoals(); updateStats();
        }

        function updateStats() {
            let total = 0, met = 0;
            if (statsView === 'COLECTIVO') {
                total = challengeData.reduce((s, g) => s + (g.completions.length * g.amount), 0);
                met = challengeData.filter(g => g.completions.length > 0).length;
                document.getElementById('statsTitle').innerText = "Total Colectivo";
            } else {
                total = challengeData.reduce((s, g) => s + (g.completions.some(c => c.participant === activeParticipant) ? g.amount : 0), 0);
                met = challengeData.filter(g => g.completions.some(c => c.participant === activeParticipant)).length;
                document.getElementById('statsTitle').innerText = `Ahorro de ${activeParticipant || '...'}`;
            }
            const percent = (met / 52) * 100;
            document.getElementById('totalSavedCounter').innerText = formatPYG(total);
            document.getElementById('completedCount').innerText = met;
            document.getElementById('progressPercentage').innerText = Math.round(percent) + '%';
            document.getElementById('globalProgressCircle').style.strokeDashoffset = 150.8 - (percent / 100 * 150.8);
        }

        function renderGoals() {
            const container = document.getElementById('goalsList');
            const data = currentFilter === 'ALL' ? challengeData : challengeData.filter(g => g.phase === currentFilter);
            const colors = { 'EMPEZAR': 'bg-emerald-500', 'SOSTENER': 'bg-sky-500', 'CONSTANCIA': 'bg-indigo-500', 'RESULTADOS': 'bg-rose-500' };
            container.innerHTML = data.map((g) => {
                const doneByActive = activeParticipant ? g.completions.some(c => c.participant === activeParticipant) : false;
                return `
                    <div class="glass-card rounded-xl p-2 flex items-center gap-4 border-l-4 ${doneByActive ? 'border-l-primary' : 'border-l-slate-200'}">
                        <div class="w-8 h-8 rounded-lg ${colors[g.phase]} flex items-center justify-center text-white text-[10px] font-bold shrink-0">${g.week}</div>
                        <div class="flex-grow"><div class="text-sm font-bold text-slate-800">${formatPYG(g.amount)}</div><div class="text-[9px] uppercase text-slate-400 font-bold">${g.phase}</div></div>
                        <div class="flex -space-x-2 shrink-0 px-2">${g.completions.map(c => `<div title="${c.participant}" class="h-5 w-5 rounded-full ring-2 ring-white bg-primary text-[8px] flex items-center justify-center text-white font-bold">${c.participant[0]}</div>`).join('')}</div>
                        <button onclick="toggle(${g.week - 1})" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${doneByActive ? 'bg-primary text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}">${doneByActive ? 'LISTO' : 'MARCAR'}</button>
                    </div>
                `;
            }).join('');
        }

        function filterPhase(p) { currentFilter = p; renderGoals(); }
        function confirmReset() { if (confirm("¿Borrar todo?")) { localStorage.clear(); location.reload(); } }
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
